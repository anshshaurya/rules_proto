#!/usr/bin/env sh

set -euo pipefail

cd $BUILD_WORKSPACE_DIRECTORY

output_base=$(bazel info output_base)
workspace=$(bazel info workspace)
external_all=$(bazel query //external:* --output build \
    | sed -e "s|${workspace}|{WORKSPACE}|g" \
    | sed -e "s|${output_base}|{OUTPUT_BASE}|g" \
)

cat << EOF > deps/externals.bzl
"""GENERATED FILE, DO NOT EDIT"""

# This file tracks the external dependencies of the build. The purpose is to be
# able to see how source code changes affect the resolved external dependencies.
# It is generated by the following script: deps/generate-externals.sh

load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

${external_all}
EOF
